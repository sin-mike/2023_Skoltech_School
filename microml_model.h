#pragma once
#include <cstdarg>
namespace Eloquent {
    namespace ML {
        namespace Port {
            class PCA {
                public:
                    /**
                    * Apply dimensionality reduction
                    * @warn Will override the source vector if no dest provided!
                    */
                    void transform(float *x, float *dest = NULL) {
                        static float u[10] = { 0 };
                        u[0] = dot(x,   0.316767823403  , 0.050663556999  , 0.414179506938  , -0.329396846747  , 0.451477580695  , 0.401354646722  , -0.102204172246  , 0.207970075606  , 0.421791971198  , 0.143251991192 );
                        u[1] = dot(x,   -0.123578635475  , -0.194831501097  , 0.137811788986  , 0.123202169457  , 0.434638205978  , -0.050261376014  , 0.671847305283  , 0.223937962684  , -0.380732762118  , 0.273271144435 );
                        u[2] = dot(x,   -0.765631751095  , -0.259390077554  , -0.069360438332  , -0.262022983522  , 0.160188405567  , 0.334928453318  , -0.087625828947  , -0.336232653984  , 0.102692170607  , 0.062802353095 );
                        u[3] = dot(x,   -0.085876476371  , 0.446198239246  , -0.122826054336  , -0.395870843204  , -0.277028616796  , 0.029945055696  , 0.64578678826  , -0.020689923506  , 0.313953829711  , -0.167496809152 );
                        u[4] = dot(x,   -0.247902455415  , 0.144343019468  , 0.652505886859  , -0.116382321646  , -0.04582311402  , -0.073366860768  , -0.083523181612  , 0.126812069358  , -0.328703341484  , -0.582936467046 );
                        u[5] = dot(x,   -0.011227177095  , 0.737385586504  , -0.091802366416  , 0.225852866304  , 0.33075776158  , 0.255277324818  , -0.10095347969  , -0.33671611244  , -0.300202632823  , 0.091875350397 );
                        u[6] = dot(x,   0.212241463148  , -0.247677896876  , -0.178531214969  , 0.262555628924  , 0.392588971636  , 0.057137892338  , 0.20597098766  , -0.328462989314  , 0.21317409872  , -0.663064362531 );
                        u[7] = dot(x,   -0.395880926832  , 0.209468251162  , 0.173572426128  , 0.583205930921  , 0.075582298195  , -0.231753216942  , -0.010350591505  , 0.238620649336  , 0.555805305271  , 0.061286823931 );
                        u[8] = dot(x,   0.163021088021  , -0.108142822608  , 0.538635922132  , 0.134104761038  , -0.238828126202  , -0.100731441083  , 0.183223546169  , -0.681580622893  , 0.103744884623  , 0.27846866913 );
                        u[9] = dot(x,   0.029900175204  , -0.10774618208  , 0.056965704713  , 0.399181799833  , -0.420088480314  , 0.765273900039  , 0.142080492922  , 0.185150829132  , -0.068761657295  , -0.059926655618 );
                        memcpy(dest != NULL ? dest : x, u, sizeof(float) * 10);
                    }

                protected:
                    /**
                    * Compute dot product with varargs
                    */
                    float dot(float *x, ...) {
                        va_list w;
                        va_start(w, 10);
                        static float mean[] = {  -0.125640524064 , -0.046407162048 , 0.007609373459 , 0.160346943473 , 0.054528138209 , -0.069291620082 , 0.16959192609 , -0.112874157536 , 0.21812875759 , 0.129494301045  };
                        float dot = 0.0;

                        for (uint16_t i = 0; i < 10; i++) {
                            dot += (x[i] - mean[i]) * va_arg(w, double);
                        }

                        return dot;
                    }
                };
            }
        }
    }